<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Edit a habit</title>
		<link rel="stylesheet" href="../css/forms.css">
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
		<script type="text/javascript" src="http://www.parsecdn.com/js/parse-latest.js"></script>
	</head>
	<body>
		<div class="forms">
			<h2>Edit A Habit</h2>
			<form>
				<p><label><span id="title_text">Habit Title</span></label></p>
				<p><input id="title" type="text" name="fullname" placeholder="Exercise 30 minutes"></p>
				<p><label>Habit Icon</label></p>
				<img id="icon1" class="icon" onclick="selectImage('icon1');" src="../img/sleep.jpg" alt="sleep image"/>
				<img id="icon2" class="icon" onclick="selectImage('icon2');" src="../img/salad.jpg" alt="eat image"/>
				<img id="icon3" class="icon" onclick="selectImage('icon3');" src="../img/run.jpg" alt="run image"/>
				<img class="icon" src="../img/add.png" alt="find a image"/>
				<p><label>Weekly Frequency</label></p>
				<div id="ck-button">
					<label> <input type="checkbox" id="sunday" name="date" value="sunday"><span>Sun</span></label>
					<label> <input type="checkbox" id="monday" name="date" value="monday"><span>Mon</span></label>
					<label> <input type="checkbox" id="tuesday" name="date" value="tuesday"><span>Tues</span></label>
					<label> <input type="checkbox" id="wednesday" name="date" value="wednesday"><span>Wed</span></label>
					<label> <input type="checkbox" id="thursday" name="date" value="thursday"><span>Thur</span></label>
					<label> <input type="checkbox" id="friday" name="date" value="friday"><span>Fri</span></label>
					<label> <input type="checkbox" id="saturday" name="date" value="saturday"><span>Sat</span></label>
				</div>
		
		
				<p><label>Daily Frequency</label></p>
				<div id="daily-button">
					<label> <input type="radio" name="day" value="one"><span>1</span></label>
					<label> <input type="radio" name="day" value="two"><span>2</span></label>
					<label> <input type="radio" name="day" value="three"><span>3</span></label>
					<span id="times">times</span>
				</div>
				<p><label><span id="others_text">Others: </span><input id="others" type="text" name="day" placeholder="More than 3 times"></label></p>
				<p id="save_p"><input id="save" type="button" value="Save It" onclick="location.href='list.html'"></p>
				
			</form>

		</div>
		<script type="text/javascript">
			Parse.initialize("rriccses0xkmfyCu8JHUbRB3n4mJW1H3okqs1Sjh", "z8QtkGlujwURiXFdYzi4SV7L9X6BxWdQG6bVecA2");
		</script>
		<script>
			var username = "Bob";
			var user;
			var habit;
			function init(){
				//fetch habit from database
				var Habit = Parse.Object.extend("Habit");
				var User = Parse.Object.extend("User");
				var userquery = new Parse.Query(User);
				userquery.equalTo("username", username);
				userquery.find({
				  success: function(object) {
				    // Do something with the returned Parse.Object values
				    user = object;
				  },
				  error: function(error) {
				    alert("Error: " + error.code + " " + error.message);
				  }
				});
				var habitname = user.get("lastEditedHabit");
				var habitquery = new Parse.Query(Habit);
				habitquery.equalTo("habitName",habitname);
				habitquery.find({
				  success: function(object) {
				    // Do something with the returned Parse.Object values
				    habit = object;
				  },
				  error: function(error) {
				    alert("Error: " + error.code + " " + error.message);
				  }
				});
				selectImage(habit.get("image"));
				document.getElementById("title").value = habit.get("habitName");
				document.getElementById('others').value = habit.get("dailyFreq");
				var weekFreq = habit.get("weekFreq");
				for(var i = 0; i < weekFreq.length; i++){
					document.getElementById(weekFreq[i]).checked = true;
				}
			}
			window.onload = init();
			//function handleInput

			var imageName/* = document.getElementById(name)*/;
			function selectImage(name) {
				//Clear all the other effects

				// Test to push
				document.getElementById('icon1').style.border = "none";
				document.getElementById('icon2').style.border = "none";
				document.getElementById('icon3').style.border = "none";
				var image = document.getElementById(name);
				image.style.border = "5px solid #42A5F5";
				imageName = name;
			}


			function saveHabit(){
				var Habit = Parse.Object.extend("Habit");
				var habit = new Habit();
				var daysofweek = [];

				var habitTitle = document.getElementById("title").value;

				// check for title
				if (!habitTitle){
					document.getElementById("habittitleError").innerHTML = '* Habit Title cannot be empty!';
					return;
				}
				else{
					// check if title already exists
					
					habitTitle = document.getElementById("title").value;

					//document.getElementById("habittitleError").innerHTML = habitTitle;

					var habitQuery = new Parse.Query(Habit);
					
					habitQuery.equalTo("habitName", habitTitle);

					document.getElementById("habittitleError").value='false';
					
					habitQuery.first({
						success: function(Habit){
							if (Habit){
								document.getElementById("habittitleError").innerHTML = '* Habit Title already exists!';
								document.getElementById("habittitleError").value='true';
							}
						},
						error: function(Habit){
							document.getElementById("habittitleError").innerHTML = '';
							document.getElementById("habittitleError").value='false';
						}

					});
					if (document.getElementById("habittitleError").value=='true'){
						return;
					}

					document.getElementById("habittitleError").innerHTML = '';
				}

				if (!imageName){
					document.getElementById("habiticonError").innerHTML = '* Habit Icon cannot be empty!';
					return;
				}
				else{
					document.getElementById("habiticonError").innerHTML = '';
				}

				$("input:checkbox[name=date]:checked").each(function(){
					daysofweek.push($(this).val());
				});

				if(daysofweek.length==0){
					//daysofweek = ["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];
					document.getElementById("weekfreError").innerHTML = '* Weekly Frequency cannot be empty!';
					return;
				}
				else{
					document.getElementById("weekfreError").innerHTML = '';
				}


				var timesPerDay = $('input[name="day"]:checked').val();
				var timesPerDayInt;
				if(typeof timesPerDay === 'undefined'){
					timesPerDay = document.getElementById('others').value;
				};
				switch(timesPerDay){
					case "one":
						timesPerDayInt = 1;
						break;
					case "two":
						timesPerDayInt = 2;
						break;
					case "three":
						timesPerDayInt = 3;
						break;
					default:
						timesPerDayInt = parseInt(timesPerDay);
						if(Number.isNaN(timesPerDayInt)){
							document.getElementById('otherError').innerHTML = '* Daily Frequency is empty or not a valid integer!';
							return;
						}
						else
						{
							document.getElementById('otherError').innerHTML = '';
						}
						break;
				}
				
				habit.save({
				  image: imageName,
				  habitName: habitTitle,
				  weekFreq: daysofweek,
				  dailyFreq: timesPerDayInt
				}, {
				  success: function(habit) {
					// The object was saved successfully.
					console.log('successfully saved habit');
					document.getElementById('save').value = 'Saved!';
					window.location.assign("list.html");
				  },
				  error: function(habit, error) {
					// The save failed.
					// error is a Parse.Error with an error code and message.
					console.log('failed to save habit');
					document.getElementById('save').value = 'Error while saving.';
				  }
				});
			}
		</script>
	</body>
</html>
